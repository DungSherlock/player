<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Video with Subtitles</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    video {
      width: 100%;
      max-width: 600px;
      display: block;
      margin-bottom: 20px;
      position: relative;
    }
    #subtitles1 {
      max-height: 150px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 10px;
      list-style: none;
      margin-bottom: 20px;
    }
    .subtitle {
      cursor: pointer;
      padding: 5px;
    }
    .subtitle:hover {
      background-color: #f0f0f0;
    }
    .active {
      background-color: yellow;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      max-width: 600px;
      margin-bottom: 20px;
    }
    .speed-control {
      display: flex;
      align-items: center;
    }
    .speed-control button {
      margin: 0 5px;
    }
    #subtitleOverlay {
      position: absolute;
      bottom: 10%;
      width: 100%;
      text-align: center;
      color: white;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
      font-size: 18px;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <h1>Video with Subtitles</h1>
  <div class="controls">
    <input type="file" id="videoFile" accept="video/*">
    <input type="file" id="subtitleFile1" accept=".srt">
    <input type="file" id="subtitleFile2" accept=".srt">
    <div class="speed-control">
      <button id="decreaseSpeed">-</button>
      <span id="speedDisplay">1x</span>
      <button id="increaseSpeed">+</button>
    </div>
  </div>

  <video id="video" playsinline controls disablePictureInPicture>
    <div id="subtitleOverlay"></div> 
  </video>

  <ul id="subtitles1"></ul>

  <script>
    const video = document.getElementById('video');
    const subtitlesList1 = document.getElementById('subtitles1');
    const videoFileInput = document.getElementById('videoFile');
    const subtitleFileInput1 = document.getElementById('subtitleFile1');
    const subtitleFileInput2 = document.getElementById('subtitleFile2');
    const decreaseSpeedButton = document.getElementById('decreaseSpeed');
    const increaseSpeedButton = document.getElementById('increaseSpeed');
    const speedDisplay = document.getElementById('speedDisplay');
    const subtitleOverlay = document.getElementById('subtitleOverlay');

    let subtitleData1 = [];
    let subtitleData2 = [];

    videoFileInput.addEventListener('change', handleVideoFile);
    subtitleFileInput1.addEventListener('change', () => handleSubtitleFile(subtitleFileInput1, subtitlesList1, false));
    subtitleFileInput2.addEventListener('change', () => handleSubtitleFile(subtitleFileInput2, null, true));
    decreaseSpeedButton.addEventListener('click', () => changeSpeed(-0.1));
    increaseSpeedButton.addEventListener('click', () => changeSpeed(0.1));

    function handleVideoFile(event) {
      const file = event.target.files[0];
      if (file) {
        const fileURL = URL.createObjectURL(file);
        video.src = fileURL;
        video.load(); 

        const fileName = file.name.split('.').slice(0, -1).join('.');
        const subtitlePath1 = fileName + '.srt';
        const subtitlePath2 = fileName + '_2.srt';

        loadSubtitle(subtitlePath1, subtitlesList1);
        loadSubtitle(subtitlePath2, null, true);
      }
    }

    function handleSubtitleFile(input, subtitlesList, isOverlay) {
      const file = input.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
          const data = event.target.result;
          const subtitles = parseSRT(data);
          if (isOverlay) {
            subtitleData2 = subtitles;
          } else {
            subtitleData1 = subtitles;
            displaySubtitles(subtitles, subtitlesList);
            setupVideoEvents(subtitleData1, subtitleData2, subtitlesList);
          }
        };
        reader.readAsText(file);
      }
    }

    function loadSubtitle(path, subtitlesList, isOverlay = false) {
      fetch(path)
        .then(response => response.text())
        .then(data => {
          const subtitles = parseSRT(data);
          if (isOverlay) {
            subtitleData2 = subtitles;
          } else {
            subtitleData1 = subtitles;
            displaySubtitles(subtitles, subtitlesList);
            setupVideoEvents(subtitleData1, subtitleData2, subtitlesList);
          }
        })
        .catch(error => console.error('Error loading subtitle:', error));
    }

    function parseSRT(data) {
      const subtitles = [];
      const srtBlocks = data.split('\n\n');
      srtBlocks.forEach(block => {
        const lines = block.split('\n');
        if (lines.length >= 3) {
          const timeMatch = lines[1].match(/(\d{2}):(\d{2}):(\d{2}),(\d{3}) --> (\d{2}):(\d{2}):(\d{2}),(\d{3})/);
          if (timeMatch) {
            const start = parseTime(timeMatch[1], timeMatch[2], timeMatch[3], timeMatch[4]);
            const end = parseTime(timeMatch[5], timeMatch[6], timeMatch[7], timeMatch[8]);
            const text = lines.slice(2).join('\n');
            subtitles.push({ start, end, text });
          }
        }
      });
      return subtitles;
    }

    function parseTime(hours, minutes, seconds, milliseconds) {
      return (
        parseInt(hours) * 3600 +
        parseInt(minutes) * 60 +
        parseInt(seconds) +
        parseInt(milliseconds) / 1000
      );
    }

    function displaySubtitles(subtitles, subtitlesList) {
      subtitlesList.innerHTML = ''; 
      subtitles.forEach((subtitle, index) => {
        const li = document.createElement('li');
        li.textContent = subtitle.text;
        li.classList.add('subtitle');
        li.dataset.start = subtitle.start;
        li.dataset.end = subtitle.end;
        li.dataset.index = index;
        subtitlesList.appendChild(li);

        li.addEventListener('click', () => {
          video.currentTime = subtitle.start;
        });
      });
    }

    function setupVideoEvents(subtitles1, subtitles2, subtitlesList) {
      video.addEventListener('timeupdate', () => {
        const currentTime = video.currentTime;

        // Handle first subtitle track
        const activeSubtitle1 = subtitles1.find(sub => currentTime >= sub.start && currentTime <= sub.end);
        document.querySelectorAll('.subtitle').forEach(sub => sub.classList.remove('active'));
        if (activeSubtitle1) {
          const activeElement1 = subtitlesList.querySelector(`.subtitle[data-index="${subtitles1.indexOf(activeSubtitle1)}"]`);
          activeElement1.classList.add('active');
          activeElement1.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Handle second subtitle track
        const activeSubtitle2 = subtitles2.find(sub => currentTime >= sub.start && currentTime <= sub.end);
        if (activeSubtitle2) {
          subtitleOverlay
